<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<c:set var="ctx" value="${pageContext.request.contextPath}"/>
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="renderer" content="webkit">
    <title>产品统计</title>
    <link rel="stylesheet" href="${ctx}/css/pintuer.css">
    <link rel="stylesheet" href="${ctx}/css/admin.css">
    <style>
        select {
            display: inline !important;
            margin-left: 10px;
            width: 15% !important;
        }
        .input {
            display: inline !important;
            width: 25%;
        }
        .pagelist{border-top: 1px solid #eee;margin-bottom: 20px}
        .panel-head form{display: inline}
    </style>
</head>
<body>
<div class="panel admin-panel">
    <div class="panel-head">
        <strong><span class="icon-cubes"></span> 产品统计</strong>
        <select class="input" name="1" id="city">
            <option value="">请选择所在城市</option>
            <c:forEach items="${cityList}" var="city">
                <option value="${city.id}">${city.name}</option>
            </c:forEach>
        </select>
        <%--<select class="input" name="2">--%>
            <%--<option value="">请选择产品分类</option>--%>
            <%--<option value="sndx">省内短线</option>--%>
            <%--<option value="gncx">国内长线</option>--%>
            <%--<option value="jwcx">境外长线</option>--%>
            <%--<option value="tdcx">团队出行</option>--%>
        <%--</select>--%>
        <%--<select class="input" name="3">--%>
            <%--<option value="sndx">按-购买次数-排列</option>--%>
            <%--<option value="gncx">按-浏览次数-排列</option>--%>
            <%--<option value="jwcx">按-收藏次数-排列</option>--%>
            <%--<option value="tdcx">按-交易金额-排列</option>--%>
        <%--</select>--%>
        <button class="button border-blue my-search float-right" disabled>
            查询 <span class="icon-search-plus"></span>
        </button>
        <input type="text" class="input key-word float-right" style="margin-right: 5px"
               name="searchTxt" placeholder="输入产品名进行查询"/>
    </div>
    <table class="table table-hover text-center">
        <tr>
            <th style="display: none">产品ID</th>
            <th width="10%">序号</th>
            <th width="30%">产品名（活动名）</th>
            <th width="10%">购买次数</th>
            <th width="10%">浏览次数</th>
            <th width="10%">收藏人数</th>
            <th width="10%">交易额</th>
            <th width="20%">参与用户信息</th>
        </tr>
    </table>
    <center>
        <div class="pagelist">
        </div>
    </center>
</div>
<script src="${ctx}/js/jquery.js"></script>
<script src="${ctx}/js/pintuer.js"></script>
<script type="text/javascript">
    $(function () {
        var citySelected = "",$city = $("#city");

        // 下拉框查询 + 分页
        $city.change(function () {
            var t = $(this);
            if (t.get(0).selectedIndex != 0) {
                citySelected = t.find("option:selected").val();
                $.ajax({
                    type: "post",
                    url: "${ctx}/productCount/productCountMessageByCity", // 请求处理页
                    dataType: "json",
                    data: {citySelected: citySelected},
                    success: function (result) {
                        var obj = eval(result.list);
                        $("table tr:not(:first)").remove();
                        for (var i = 0; i < obj.length; i++) {
                            var val = obj[i];
                            $("table").append("<tr>" +
                                "<td style='display: none'>"+val.productId+"</td>" +
                                "<td>"+(i+1+(result.pageNum-1)*10)+"</td>"+
                                "<td>"+val.productName+"</td>" +
                                "<td>"+val.productBuyNumber+"</td>" +
                                "<td>"+val.productReadNumber+"</td>" +
                                "<td>"+val.productCollectionNumber+"</td>" +
                                "<td>"+(val.productSumMoney * 0.01)+"</td>" +
                                "<td><a href='${ctx}/productCount/checkUsersMessageByProductId?productId="+ val.productId +"'>查看</a> </td>" +
                                "</tr>");
                        }
                        $(".pagelist").html("");
                        if (!result.isFirstPage){
                            $(".pagelist").append("" +
                                "<a id='" + 1 + "," + result.pageSize +"," + citySelected +"'>首页</a>" +
                                "<a id='" + result.prePage + "," + result.pageSize + "," + citySelected +"'>上一页</a>")
                        }
                        for (var p = 0;p < result.navigatepageNums.length;p++){
                            if(result.navigatepageNums[p] == result.pageNum){
                                $(".pagelist").append("<span class='current'>"+ result.navigatepageNums[p] +"</span>");
                            }
                            if(result.navigatepageNums[p] != result.pageNum){
                                $(".pagelist").append("<a id='" + result.navigatepageNums[p] +"," + result.pageSize + "," + citySelected + "'>"+ result.navigatepageNums[p] +"</a>");
                            }
                        }
                        if(!result.isLastPage){
                            $(".pagelist").append("" +
                                "<a id='" + result.nextPage + "," + result.pageSize +"," + citySelected + "'>下一页</a>" +
                                "<a id='"+ result.pages + "," + result.pageSize + "," + citySelected + "'>尾页</a>")
                        }
                        $(".pagelist").append("&nbsp;&nbsp;&nbsp;&nbsp;当前页：第 " + result.pageNum + " 页")
                    },
                    error: function () {
                        alert("系统繁忙，请稍后再试");
                    }
                });
            }
        });
        $city.find("option:eq(1)").attr("selected",true);
        firstLoad($city);

        // 下拉框查询 + 页面跳转
        $(document).on("click",".pagelist a",function () {
            var aID = $(this).attr("id");
            citySelected = $city.find("option:selected").val(); //作用域问题，仍为空值，需要赋值
            $.ajax({
                type: "post",
                url: "${ctx}/productCount/productCountMessageByCity", // 请求处理页
                dataType: "json",
                data: {aID: aID},
                success: function (result) {
                    var obj = eval(result.list);
                    $("table tr:not(:first)").remove();
                    for (var i = 0; i < obj.length; i++) {
                        var val = obj[i];
                        $("table").append("<tr>" +
                            "<td style='display: none'>"+val.productId+"</td>" +
                            "<td>"+(i+1+(result.pageNum-1)*10)+"</td>"+
                            "<td>"+val.productName+"</td>" +
                            "<td>"+val.productBuyNumber+"</td>" +
                            "<td>"+val.productReadNumber+"</td>" +
                            "<td>"+val.productCollectionNumber+"</td>" +
                            "<td>"+(val.productSumMoney * 0.01)+"</td>" +
                            "<td><a href='${ctx}/productCount/checkUsersMessageByProductId?productId="+ val.productId +"'>查看</a> </td>" +
                            "</tr>");
                    }
                    $(".pagelist").html("");
                    if (!result.isFirstPage){
                        $(".pagelist").append("" +
                            "<a class='first' id='" + 1 + "," + result.pageSize +"," + citySelected +"'>首页</a>" +
                            "<a class='prev' id='" + result.prePage + "," + result.pageSize + "," + citySelected +"'>上一页</a>")
                    }
                    for (var p = 0;p < result.navigatepageNums.length;p++){
                        if(result.navigatepageNums[p] == result.pageNum){
                            $(".pagelist").append("<span class='current'>"+ result.navigatepageNums[p] +"</span>");
                        }
                        if(result.navigatepageNums[p] != result.pageNum){
                            $(".pagelist").append("<a id='" + result.navigatepageNums[p] +"," + result.pageSize + "," + citySelected + "'>"+ result.navigatepageNums[p] +"</a>");
                        }
                    }
                    if(!result.isLastPage){
                        $(".pagelist").append("" +
                            "<a class='next' id='" + result.nextPage + "," + result.pageSize +"," + citySelected + "'>下一页</a>" +
                            "<a class='last' id='"+ result.pages + "," + result.pageSize + "," + citySelected + "'>尾页</a>")
                    }
                    $(".pagelist").append("&nbsp;&nbsp;&nbsp;&nbsp;当前页：第 " + result.pageNum + " 页")
                },
                error:function () {
                    alert("系统错误");
                }
            })
        });

        // 输入框查询 + 分页
        var productName = "";
        $(".my-search").click(function () {
            productName = $("input[name=searchTxt]").val();
            $.ajax({
                type: "post",
                url: "${ctx}/productCount/checkProductCountByProductName", // 请求处理页
                dataType: "json",
                data: {productName: productName},
                success: function (result) {
                    var obj = eval(result.list);
                    $("table tr:not(:first)").remove();
                    for (var i = 0; i < obj.length; i++) {
                        var val = obj[i];
                        $("table").append("<tr>" +
                            "<td style='display: none'>"+val.productId+"</td>" +
                            "<td>"+(i+1+(result.pageNum-1)*10)+"</td>"+
                            "<td>"+val.productName+"</td>" +
                            "<td>"+val.productBuyNumber+"</td>" +
                            "<td>"+val.productReadNumber+"</td>" +
                            "<td>"+val.productCollectionNumber+"</td>" +
                            "<td>"+(val.productSumMoney * 0.01)+"</td>" +
                            "<td><a href='${ctx}/productCount/checkUsersMessageByProductId?productId="+ val.productId +"'>查看</a></td>" +
                            "</tr>");
                    }
                    $(".pagelist").html("");
                    if (!result.isFirstPage){
                        $(".pagelist").append("" +
                            "<span id='" + 1 + "," + result.pageSize +"," + productName +"'>首页</span>&nbsp;" +
                            "<span id='" + result.prePage + "," + result.pageSize + "," + productName +"'>上一页</span>&nbsp;")
                    }
                    for (var p = 0;p < result.navigatepageNums.length;p++){
                        if(result.navigatepageNums[p] == result.pageNum){
                            $(".pagelist").append("<span class='current'>"+ result.navigatepageNums[p] +"</span>&nbsp;");
                        }
                        if(result.navigatepageNums[p] != result.pageNum){
                            $(".pagelist").append("<span id='" + result.navigatepageNums[p] +"," + result.pageSize + "," + productName + "'>"+ result.navigatepageNums[p] +"</span>&nbsp;");
                        }
                    }
                    if(!result.isLastPage){
                        $(".pagelist").append("" +
                            "<span id='" + result.nextPage + "," + result.pageSize +"," + productName + "'>下一页</span>&nbsp;" +
                            "<span id='"+ result.pages + "," + result.pageSize + "," + productName + "'>尾页</span>")
                    }
                    $(".pagelist").append("&nbsp;&nbsp;&nbsp;&nbsp;当前页：第 " + result.pageNum + " 页")
                },error:function () {
                    alert("系统繁忙，请稍后再试");
                }
            });
        });
        // 输入框查询 + 页面跳转
        $(document).on("click",".pagelist span",function () {
            var spanID = $(this).attr("id");
            $.ajax({
                type: "post",
                url: "${ctx}/productCount/checkProductCountByProductName", // 请求处理页
                dataType: "json",
                data: {spanID: spanID},
                success: function (result) {
                    var obj = eval(result.list);
                    $("table tr:not(:first)").remove();
                    for (var i = 0; i < obj.length; i++) {
                        var val = obj[i];
                        $("table").append("<tr>" +
                            "<td style='display: none'>"+val.productId+"</td>" +
                            "<td>"+(i+1+(result.pageNum-1)*10)+"</td>"+
                            "<td>"+val.productName+"</td>" +
                            "<td>"+val.productBuyNumber+"</td>" +
                            "<td>"+val.productReadNumber+"</td>" +
                            "<td>"+val.productCollectionNumber+"</td>" +
                            "<td>"+(val.productSumMoney * 0.01)+"</td>" +
                            "<td><a href='${ctx}/productCount/checkUsersMessageByProductId?productId="+ val.productId +"'>查看</a> </td>" +
                            "</tr>");
                    }
                    $(".pagelist").html("");
                    if (!result.isFirstPage){
                        $(".pagelist").append("" +
                            "<span id='" + 1 + "," + result.pageSize +"," + productName +"'>首页</span>&nbsp;" +
                            "<span id='" + result.prePage + "," + result.pageSize + "," + productName +"'>上一页</span>&nbsp;")
                    }
                    for (var p = 0;p < result.navigatepageNums.length;p++){
                        if(result.navigatepageNums[p] == result.pageNum){
                            $(".pagelist").append("<span class='current'>"+ result.navigatepageNums[p] +"</span>&nbsp;");
                        }
                        if(result.navigatepageNums[p] != result.pageNum){
                            $(".pagelist").append("<span id='" + result.navigatepageNums[p] +"," + result.pageSize + "," + productName + "'>"+ result.navigatepageNums[p] +"</span>&nbsp;");
                        }
                    }
                    if(!result.isLastPage){
                        $(".pagelist").append("" +
                            "<span id='" + result.nextPage + "," + result.pageSize +"," + productName + "'>下一页</span>&nbsp;" +
                            "<span id='"+ result.pages + "," + result.pageSize + "," + productName + "'>尾页</span>")
                    }
                    $(".pagelist").append("&nbsp;&nbsp;&nbsp;&nbsp;当前页：第 " + result.pageNum + " 页")
                },
                error:function () {
                    alert("系统错误");
                }
            })
        });
        $(".key-word").on("input",function () {
            if($(this).val()!= ""){
                $(".my-search").attr("disabled",false);
            }else{
                $(".my-search").attr("disabled",true);
            }
        })
    });

    //首次加载直接触发珠海option的数据查询
    function firstLoad(obj) {
        var t = obj,citySelected;
        if (t.get(0).selectedIndex != 0) {
            citySelected = t.find("option:selected").val();
            $.ajax({
                type: "post",
                url: "${ctx}/productCount/productCountMessageByCity", // 请求处理页
                dataType: "json",
                data: {citySelected: citySelected},
                success: function (result) {
                    var obj = eval(result.list);
                    $("table tr:not(:first)").remove();
                    for (var i = 0; i < obj.length; i++) {
                        var val = obj[i];
                        $("table").append("<tr>" +
                            "<td style='display: none'>"+val.productId+"</td>" +
                            "<td>"+(i+1+(result.pageNum-1)*10)+"</td>"+
                            "<td>"+val.productName+"</td>" +
                            "<td>"+val.productBuyNumber+"</td>" +
                            "<td>"+val.productReadNumber+"</td>" +
                            "<td>"+val.productCollectionNumber+"</td>" +
                            "<td>"+(val.productSumMoney * 0.01)+"</td>" +
                            "<td><a href='${ctx}/productCount/checkUsersMessageByProductId?productId="+ val.productId +"'>查看</a> </td>" +
                            "</tr>");
                    }
                    $(".pagelist").html("");
                    if (!result.isFirstPage){
                        $(".pagelist").append("" +
                            "<a id='" + 1 + "," + result.pageSize +"," + citySelected +"'>首页</a>" +
                            "<a id='" + result.prePage + "," + result.pageSize + "," + citySelected +"'>上一页</a>")
                    }
                    for (var p = 0;p < result.navigatepageNums.length;p++){
                        if(result.navigatepageNums[p] == result.pageNum){
                            $(".pagelist").append("<span class='current'>"+ result.navigatepageNums[p] +"</span>");
                        }
                        if(result.navigatepageNums[p] != result.pageNum){
                            $(".pagelist").append("<a id='" + result.navigatepageNums[p] +"," + result.pageSize + "," + citySelected + "'>"+ result.navigatepageNums[p] +"</a>");
                        }
                    }
                    if(!result.isLastPage){
                        $(".pagelist").append("" +
                            "<a id='" + result.nextPage + "," + result.pageSize +"," + citySelected + "'>下一页</a>" +
                            "<a id='"+ result.pages + "," + result.pageSize + "," + citySelected + "'>尾页</a>")
                    }
                    $(".pagelist").append("&nbsp;&nbsp;&nbsp;&nbsp;当前页：第 " + result.pageNum + " 页")
                },
                error: function () {
                    alert("系统繁忙，请稍后再试");
                }
            });
        }
    }
</script>
</body>
</html>
